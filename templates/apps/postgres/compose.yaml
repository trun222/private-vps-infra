############################################
# Shared PostgreSQL Cluster
# ~/srv/apps/postgres/compose.yaml
#
# This is the central database for all apps.
# Each app gets its own database and user.
############################################

services:
  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERPASS}
      # Use the data directory we mount
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      # Persistent data
      - /srv/data/postgres/data:/var/lib/postgresql/data
      # Init scripts (run once on first start)
      - ./initdb:/docker-entrypoint-initdb.d:ro
    networks:
      - internal
    # Expose on localhost only for SSH tunnel access (BeeKeeper, etc.)
    # NOT exposed to public internet
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      com.builtwithwisdom.app: "postgres"
      com.builtwithwisdom.env: "prod"
      com.builtwithwisdom.service: "database"

############################################
# Networks
############################################
networks:
  internal:
    external: true
    name: internal
