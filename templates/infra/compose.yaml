############################################
# Core VPS Infrastructure
# ~/srv/infra/compose.yaml
############################################

services:
  ############################################
  # Reverse proxy / HTTPS entrypoint
  ############################################
  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    depends_on:
      - docker-socket-proxy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3 (QUIC)
    networks:
      - edge
      - internal
    environment:
      DOCKER_HOST: tcp://docker-socket-proxy:2375
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/data:/data
      - ./caddy/config:/config

  ############################################
  # Tailscale mesh VPN (admin access, private services)
  ############################################
  tailscale:
    image: tailscale/tailscale:stable
    container_name: tailscale
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_HOSTNAME: ${TS_HOSTNAME:-hetzner-vps}
      TS_ACCEPT_DNS: "false"
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun

  ############################################
  # Docker socket proxy (filtered API access)
  ############################################
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    networks:
      - internal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: 1
      SERVICES: 1
      NETWORKS: 1
      TASKS: 1
      POST: 0
      DELETE: 0
      BUILD: 0
      IMAGES: 0
      SYSTEM: 0
      VOLUMES: 0
      INFO: 0
      EXEC: 0

  ############################################
  # Grafana (dashboards & visualization)
  ############################################
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    networks:
      - internal
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-https://grafana.dev.internal}
    volumes:
      - /srv/data/observability/grafana:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro

  ############################################
  # Loki (log aggregation)
  ############################################
  loki:
    image: grafana/loki:2.9.8
    container_name: loki
    restart: unless-stopped
    networks:
      - internal
    command: ["-config.file=/etc/loki/config.yaml"]
    volumes:
      - ./observability/loki/config.yaml:/etc/loki/config.yaml:ro
      - /srv/data/observability/loki:/loki

  ############################################
  # Prometheus (metrics collection)
  ############################################
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    networks:
      - internal
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}"
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus/rules:/etc/prometheus/rules:ro
      - /srv/data/observability/prometheus:/prometheus

  ############################################
  # Node Exporter (host metrics)
  ############################################
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    networks:
      - internal
    pid: host
    command:
      - "--path.rootfs=/host"
    volumes:
      - "/:/host:ro,rslave"

  ############################################
  # cAdvisor (container metrics)
  ############################################
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    networks:
      - internal
    volumes:
      - "/:/rootfs:ro"
      - "/var/run:/var/run:ro"
      - "/sys:/sys:ro"
      - "/var/lib/docker/:/var/lib/docker:ro"

  ############################################
  # Alloy (log collection agent)
  ############################################
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    restart: unless-stopped
    networks:
      - internal
    command:
      - "run"
      - "--server.http.listen-addr=0.0.0.0:12345"
      - "/etc/alloy/config.alloy"
    volumes:
      - ./observability/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

############################################
# Networks
############################################
networks:
  edge:
    name: edge
  internal:
    name: internal
    internal: true

############################################
# Volumes
############################################
volumes:
  tailscale-state:
